import asyncio
import logging
import os
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
from ai_openrouter import openrouter_ai

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)

BOT_TOKEN = os.getenv("BOT_TOKEN")
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

# –•—Ä–∞–Ω–∏–º –≤—ã–±–æ—Ä –ø–∏—Å–∞—Ç–µ–ª—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
user_sessions = {}

# –ö—Ä–∞—Å–∏–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
def get_main_keyboard():
    keyboard = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="üìö –í—ã–±—Ä–∞—Ç—å –ø–∏—Å–∞—Ç–µ–ª—è"), KeyboardButton(text="‚ÑπÔ∏è –û –ø—Ä–æ–µ–∫—Ç–µ")],
            [KeyboardButton(text="üåü –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏"), KeyboardButton(text="üí´ –°–ª—É—á–∞–π–Ω—ã–π –ø–∏—Å–∞—Ç–µ–ª—å")]
        ],
        resize_keyboard=True,
        input_field_placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
    )
    return keyboard

def get_writers_keyboard():
    keyboard = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="üñãÔ∏è –ü—É—à–∫–∏–Ω"), KeyboardButton(text="üé≠ –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π")],
            [KeyboardButton(text="üìñ –¢–æ–ª—Å—Ç–æ–π"), KeyboardButton(text="‚úíÔ∏è –ß–µ—Ö–æ–≤")],
            [KeyboardButton(text="üîÆ –ì–æ–≥–æ–ª—å"), KeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥")]
        ],
        resize_keyboard=True,
        input_field_placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –ø–∏—Å–∞—Ç–µ–ª—è –¥–ª—è –±–µ—Å–µ–¥—ã..."
    )
    return keyboard

@dp.message(Command("start"))
async def start_command(message: types.Message):
    welcome_text = """
üåü *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã—Ö –±–µ—Å–µ–¥!* üåü

–Ø ‚Äî –≤–∞—à –ø—Ä–æ–≤–æ–¥–Ω–∏–∫ –≤ –º–∏—Ä –≤–µ–ª–∏–∫–æ–π —Ä—É—Å—Å–∫–æ–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã. 
–í—ã–±–µ—Ä–∏—Ç–µ –ø–∏—Å–∞—Ç–µ–ª—è –∏ –ø–æ–≥—Ä—É–∑–∏—Ç–µ—Å—å –≤ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –¥–∏–∞–ª–æ–≥!

*‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:*
‚Ä¢ –ë–µ—Å–µ–¥—ã —Å –≤–µ–ª–∏–∫–∏–º–∏ –ø–∏—Å–∞—Ç–µ–ª—è–º–∏
‚Ä¢ –ì–ª—É–±–æ–∫–∏–µ —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–µ –¥–∏—Å–∫—É—Å—Å–∏–∏  
‚Ä¢ –°—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –≤ –¥—É—Ö–µ —ç–ø–æ—Ö–∏
‚Ä¢ –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ

*üéØ –ö–∞–∫ –Ω–∞—á–∞—Ç—å:*
–ù–∞–∂–º–∏—Ç–µ ¬´üìö –í—ã–±—Ä–∞—Ç—å –ø–∏—Å–∞—Ç–µ–ª—è¬ª –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –∏–º—è –∞–≤—Ç–æ—Ä–∞
    """
    
    await message.answer(welcome_text, parse_mode="Markdown", reply_markup=get_main_keyboard())

@dp.message(Command("writers"))
async def show_writers(message: types.Message):
    writers_text = """
üé≠ *–í—ã–±–µ—Ä–∏—Ç–µ –ø–∏—Å–∞—Ç–µ–ª—è –¥–ª—è –±–µ—Å–µ–¥—ã:*

*üñãÔ∏è –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ü—É—à–∫–∏–Ω* ‚Äî —Ä–æ–º–∞–Ω—Ç–∏—á–Ω—ã–π, –æ—Å—Ç—Ä–æ—É–º–Ω—ã–π, —ç–ª–µ–≥–∞–Ω—Ç–Ω—ã–π
*üé≠ –§—ë–¥–æ—Ä –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π* ‚Äî –≥–ª—É–±–æ–∫–∏–π —Ñ–∏–ª–æ—Å–æ—Ñ, –ø—Å–∏—Ö–æ–ª–æ–≥ –¥—É—à–∏  
*üìñ –õ–µ–≤ –¢–æ–ª—Å—Ç–æ–π* ‚Äî –º—É–¥—Ä—ã–π, –ø—Ä–æ—Å—Ç–æ–π, –Ω—Ä–∞–≤—Å—Ç–≤–µ–Ω–Ω—ã–π
*‚úíÔ∏è –ê–Ω—Ç–æ–Ω –ß–µ—Ö–æ–≤* ‚Äî –∏—Ä–æ–Ω–∏—á–Ω—ã–π, –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π, –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å–Ω—ã–π
*üîÆ –ù–∏–∫–æ–ª–∞–π –ì–æ–≥–æ–ª—å* ‚Äî –º–∏—Å—Ç–∏—á–µ—Å–∫–∏–π, —Å —é–º–æ—Ä–æ–º, –æ–±—Ä–∞–∑–Ω—ã–π

–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É —Å –∏–º–µ–Ω–µ–º –ø–∏—Å–∞—Ç–µ–ª—è –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –µ–≥–æ –∏–º—è
    """
    
    await message.answer(writers_text, parse_mode="Markdown", reply_markup=get_writers_keyboard())

@dp.message(Command("help"))
async def help_command(message: types.Message):
    help_text = """
üìñ *–ü–æ–º–æ—â—å –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞*

*–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*
/start ‚Äî –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É
/writers ‚Äî –≤—ã–±—Ä–∞—Ç—å –ø–∏—Å–∞—Ç–µ–ª—è  
/help ‚Äî —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞

*üéØ –ö–∞–∫ –æ–±—â–∞—Ç—å—Å—è:*
1. –í—ã–±–µ—Ä–∏—Ç–µ –ø–∏—Å–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –º–µ–Ω—é –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –µ–≥–æ –∏–º—è
2. –ó–∞–¥–∞–≤–∞–π—Ç–µ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã ‚Äî –æ—Ç –±—ã—Ç–æ–≤—ã—Ö –¥–æ —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏—Ö
3. –ü–æ–ª—É—á–∞–π—Ç–µ —Å—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –≤ –¥—É—Ö–µ –∞–≤—Ç–æ—Ä–∞

*üí´ –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:*
‚Ä¢ –û—Ç–≤–µ—Ç—ã –±–µ–∑ —Å–º–∞–π–ª–∏–∫–æ–≤ –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–ª–µ–Ω–≥–∞
‚Ä¢ –ê—É—Ç–µ–Ω—Ç–∏—á–Ω—ã–π —Å—Ç–∏–ª—å —Ä–µ—á–∏ –∫–∞–∂–¥–æ–≥–æ –ø–∏—Å–∞—Ç–µ–ª—è
‚Ä¢ –ì–ª—É–±–æ–∫–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
‚Ä¢ –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –¥–∏–∞–ª–æ–≥

–ù–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å –±–µ—Å–µ–¥–æ–π! üìö
    """
    
    await message.answer(help_text, parse_mode="Markdown")

@dp.message(lambda message: message.text == "üìö –í—ã–±—Ä–∞—Ç—å –ø–∏—Å–∞—Ç–µ–ª—è")
async def select_writer_button(message: types.Message):
    await show_writers(message)

@dp.message(lambda message: message.text == "‚¨ÖÔ∏è –ù–∞–∑–∞–¥")
async def back_button(message: types.Message):
    await start_command(message)

@dp.message(lambda message: message.text == "‚ÑπÔ∏è –û –ø—Ä–æ–µ–∫—Ç–µ")
async def about_project(message: types.Message):
    about_text = """
*üìö –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫* ‚Äî —ç—Ç–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π –≤–µ—Å—Ç–∏ –¥–∏–∞–ª–æ–≥–∏ —Å –≤–µ–ª–∏–∫–∏–º–∏ —Ä—É—Å—Å–∫–∏–º–∏ –ø–∏—Å–∞—Ç–µ–ª—è–º–∏.

*üéØ –¶–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞:*
‚Ä¢ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫—É–ª—å—Ç—É—Ä–Ω–æ–µ –Ω–∞—Å–ª–µ–¥–∏–µ
‚Ä¢ –°–¥–µ–ª–∞—Ç—å –∫–ª–∞—Å—Å–∏—á–µ—Å–∫—É—é –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—É –±–ª–∏–∂–µ
‚Ä¢ –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
‚Ä¢ –í–¥–æ—Ö–Ω–æ–≤–∏—Ç—å –Ω–∞ —á—Ç–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∏–∫–∏

*‚ú® –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:*
‚Ä¢ –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–≤—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
‚Ä¢ –ì–ª—É–±–æ–∫–æ–µ –ø–æ–≥—Ä—É–∂–µ–Ω–∏–µ –≤ —Å—Ç–∏–ª–∏—Å—Ç–∏–∫—É
‚Ä¢ –¢–æ—á–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Ä–µ—á–µ–≤—ã—Ö –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π

*–ü—Ä–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ –ª—é–±–∏—Ç–µ–ª–µ–π —Ä—É—Å—Å–∫–æ–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã* üá∑üá∫
    """
    
    await message.answer(about_text, parse_mode="Markdown")

@dp.message(lambda message: message.text == "üåü –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏")
async def recommendations(message: types.Message):
    rec_text = """
*üåü –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≥–ª—É–±–æ–∫–æ–π –±–µ—Å–µ–¥—ã:*

*üñãÔ∏è –° –ü—É—à–∫–∏–Ω—ã–º:*
‚Ä¢ –û –ª—é–±–≤–∏ –∏ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–∏
‚Ä¢ –û —Å–≤–æ–±–æ–¥–µ –∏ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–µ  
‚Ä¢ –û –¥—Ä—É–∂–±–µ –∏ –ø—Ä–µ–¥–∞–Ω–Ω–æ—Å—Ç–∏

*üé≠ –° –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–º:*
‚Ä¢ –û –ø—Ä–∏—Ä–æ–¥–µ –¥–æ–±—Ä–∞ –∏ –∑–ª–∞
‚Ä¢ –û —Å–º—ã—Å–ª–µ —Å—Ç—Ä–∞–¥–∞–Ω–∏—è
‚Ä¢ –û —Å–≤–æ–±–æ–¥–µ –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

*üìñ –° –¢–æ–ª—Å—Ç—ã–º:*
‚Ä¢ –û —Å–º—ã—Å–ª–µ –∂–∏–∑–Ω–∏
‚Ä¢ –û –Ω—Ä–∞–≤—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –≤–µ—Ä–µ
‚Ä¢ –û –ø—Ä–æ—Å—Ç–æ—Ç–µ –∏ –º—É–¥—Ä–æ—Å—Ç–∏

*‚úíÔ∏è –° –ß–µ—Ö–æ–≤—ã–º:*
‚Ä¢ –û —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞—Ö
‚Ä¢ –û –∏—Ä–æ–Ω–∏–∏ –∂–∏–∑–Ω–∏
‚Ä¢ –û –Ω–∞–±–ª—é–¥–µ–Ω–∏—è—Ö –∑–∞ –æ–±—â–µ—Å—Ç–≤–æ–º

*üîÆ –° –ì–æ–≥–æ–ª–µ–º:*
‚Ä¢ –û –º–∏—Å—Ç–∏–∫–µ –∏ –∑–∞–≥–∞–¥–∫–∞—Ö
‚Ä¢ –û —é–º–æ—Ä–µ –≤ –∂–∏–∑–Ω–∏
‚Ä¢ –û –Ω–µ–æ–±—ã—á–Ω—ã—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞—Ö

*üí° –°–æ–≤–µ—Ç:* –ù–µ –±–æ–π—Ç–µ—Å—å –∑–∞–¥–∞–≤–∞—Ç—å –≥–ª—É–±–æ–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã!
    """
    
    await message.answer(rec_text, parse_mode="Markdown")

@dp.message(lambda message: message.text == "üí´ –°–ª—É—á–∞–π–Ω—ã–π –ø–∏—Å–∞—Ç–µ–ª—å")
async def random_writer(message: types.Message):
    import random
    writers = ["–ø—É—à–∫–∏–Ω", "–¥–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π", "—Ç–æ–ª—Å—Ç–æ–π", "—á–µ—Ö–æ–≤", "–≥–æ–≥–æ–ª—å"]
    selected_writer = random.choice(writers)
    
    user_sessions[message.from_user.id] = selected_writer
    
    writer_names = {
        "–ø—É—à–∫–∏–Ω": "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –°–µ—Ä–≥–µ–µ–≤–∏—á –ü—É—à–∫–∏–Ω",
        "–¥–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π": "–§—ë–¥–æ—Ä –ú–∏—Ö–∞–π–ª–æ–≤–∏—á –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π", 
        "—Ç–æ–ª—Å—Ç–æ–π": "–õ–µ–≤ –ù–∏–∫–æ–ª–∞–µ–≤–∏—á –¢–æ–ª—Å—Ç–æ–π",
        "—á–µ—Ö–æ–≤": "–ê–Ω—Ç–æ–Ω –ü–∞–≤–ª–æ–≤–∏—á –ß–µ—Ö–æ–≤",
        "–≥–æ–≥–æ–ª—å": "–ù–∏–∫–æ–ª–∞–π –í–∞—Å–∏–ª—å–µ–≤–∏—á –ì–æ–≥–æ–ª—å"
    }
    
    await message.answer(
        f"üé≤ *–°–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä: {writer_names[selected_writer]}!*\n\n"
        f"–¢–µ–ø–µ—Ä—å —è –±—É–¥—É –æ—Ç–≤–µ—á–∞—Ç—å –≤ –µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–º —Å—Ç–∏–ª–µ. "
        f"–ó–∞–¥–∞–≤–∞–π—Ç–µ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã - –æ—Ç –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã—Ö –¥–æ —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏—Ö!",
        parse_mode="Markdown",
        reply_markup=get_main_keyboard()
    )

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–∏—Å–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏
@dp.message(lambda message: message.text in ["üñãÔ∏è –ü—É—à–∫–∏–Ω", "üé≠ –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π", "üìñ –¢–æ–ª—Å—Ç–æ–π", "‚úíÔ∏è –ß–µ—Ö–æ–≤", "üîÆ –ì–æ–≥–æ–ª—å"])
async def handle_writer_button(message: types.Message):
    writer_map = {
        "üñãÔ∏è –ü—É—à–∫–∏–Ω": "–ø—É—à–∫–∏–Ω",
        "üé≠ –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π": "–¥–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π", 
        "üìñ –¢–æ–ª—Å—Ç–æ–π": "—Ç–æ–ª—Å—Ç–æ–π",
        "‚úíÔ∏è –ß–µ—Ö–æ–≤": "—á–µ—Ö–æ–≤",
        "üîÆ –ì–æ–≥–æ–ª—å": "–≥–æ–≥–æ–ª—å"
    }
    
    writer = writer_map[message.text]
    user_sessions[message.from_user.id] = writer
    
    writer_names = {
        "–ø—É—à–∫–∏–Ω": "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –°–µ—Ä–≥–µ–µ–≤–∏—á –ü—É—à–∫–∏–Ω",
        "–¥–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π": "–§—ë–¥–æ—Ä –ú–∏—Ö–∞–π–ª–æ–≤–∏—á –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π",
        "—Ç–æ–ª—Å—Ç–æ–π": "–õ–µ–≤ –ù–∏–∫–æ–ª–∞–µ–≤–∏—á –¢–æ–ª—Å—Ç–æ–π", 
        "—á–µ—Ö–æ–≤": "–ê–Ω—Ç–æ–Ω –ü–∞–≤–ª–æ–≤–∏—á –ß–µ—Ö–æ–≤",
        "–≥–æ–≥–æ–ª—å": "–ù–∏–∫–æ–ª–∞–π –í–∞—Å–∏–ª—å–µ–≤–∏—á –ì–æ–≥–æ–ª—å"
    }
    
    welcome_messages = {
        "–ø—É—à–∫–∏–Ω": "–û, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é –≤–∞—Å, –º–æ–π –¥—Ä—É–≥! –ì–æ—Ç–æ–≤ –∫ –∏–∑—è—â–Ω–æ–π –±–µ—Å–µ–¥–µ –æ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ–º –∏ –≤–µ—á–Ω–æ–º. üñãÔ∏è",
        "–¥–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ... –ì–æ—Ç–æ–≤ –æ–±—Å—É–¥–∏—Ç—å —Å–∞–º—ã–µ —Å–æ–∫—Ä–æ–≤–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–π –¥—É—à–∏. üé≠", 
        "—Ç–æ–ª—Å—Ç–æ–π": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –¥—Ä—É–≥ –º–æ–π. –î–∞–≤–∞–π—Ç–µ –ø–æ–≥–æ–≤–æ—Ä–∏–º –æ –≤–∞–∂–Ω–æ–º - –æ –∂–∏–∑–Ω–∏, –≤–µ—Ä–µ –∏ –Ω—Ä–∞–≤—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏. üìñ",
        "—á–µ—Ö–æ–≤": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ. –ì–æ—Ç–æ–≤ –∫ —Ç–æ—á–Ω—ã–º –Ω–∞–±–ª—é–¥–µ–Ω–∏—è–º –∏ –∏—Ä–æ–Ω–∏—á–Ω—ã–º –∑–∞–º–µ—Ç–∫–∞–º –æ –∂–∏–∑–Ω–∏. ‚úíÔ∏è",
        "–≥–æ–≥–æ–ª—å": "–ê, –∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ì–æ—Ç–æ–≤ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å –æ —Å–∞–º–æ–º –Ω–µ–æ–±—ã—á–Ω–æ–º –∏ –∑–∞–≥–∞–¥–æ—á–Ω–æ–º! üîÆ"
    }
    
    await message.answer(
        f"*{writer_names[writer]}*\n\n"
        f"{welcome_messages[writer]}\n\n"
        f"–ó–∞–¥–∞–≤–∞–π—Ç–µ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã - —è –æ—Ç–≤–µ—á—É –≤ —Å–≤–æ—ë–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–º —Å—Ç–∏–ª–µ!",
        parse_mode="Markdown",
        reply_markup=get_main_keyboard()
    )

@dp.message()
async def handle_message(message: types.Message):
    user_id = message.from_user.id
    text = message.text
    
    # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
    if text in ["üìö –í—ã–±—Ä–∞—Ç—å –ø–∏—Å–∞—Ç–µ–ª—è", "‚ÑπÔ∏è –û –ø—Ä–æ–µ–∫—Ç–µ", "üåü –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏", "üí´ –°–ª—É—á–∞–π–Ω—ã–π –ø–∏—Å–∞—Ç–µ–ª—å", "‚¨ÖÔ∏è –ù–∞–∑–∞–¥"]:
        return
    
    # –ï—Å–ª–∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω –ø–∏—Å–∞—Ç–µ–ª—å - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
    if user_id in user_sessions and user_sessions[user_id]:
        writer = user_sessions[user_id]
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å "–ø–µ—á–∞—Ç–∞–µ—Ç"
        await message.bot.send_chat_action(message.chat.id, "typing")
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ –Ω–∞—à—É —É–ª—å—Ç—Ä–∞-—Å–∏—Å—Ç–µ–º—É
        ai_response = await openrouter_ai.generate_response(writer, text)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫—Ä–∞—Å–∏–≤—ã–π –æ—Ç–≤–µ—Ç
        await message.answer(
            f"*{writer.title()}:* {ai_response}",
            parse_mode="Markdown"
        )
        return
    
    # –í—ã–±–æ—Ä –ø–∏—Å–∞—Ç–µ–ª—è –ø–æ —Ç–µ–∫—Å—Ç—É
    writers = ["–ø—É—à–∫–∏–Ω", "–¥–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π", "—Ç–æ–ª—Å—Ç–æ–π", "—á–µ—Ö–æ–≤", "–≥–æ–≥–æ–ª—å"]
    for writer in writers:
        if writer in text.lower():
            user_sessions[user_id] = writer
            writer_names = {
                "–ø—É—à–∫–∏–Ω": "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –°–µ—Ä–≥–µ–µ–≤–∏—á –ü—É—à–∫–∏–Ω",
                "–¥–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π": "–§—ë–¥–æ—Ä –ú–∏—Ö–∞–π–ª–æ–≤–∏—á –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π",
                "—Ç–æ–ª—Å—Ç–æ–π": "–õ–µ–≤ –ù–∏–∫–æ–ª–∞–µ–≤–∏—á –¢–æ–ª—Å—Ç–æ–π",
                "—á–µ—Ö–æ–≤": "–ê–Ω—Ç–æ–Ω –ü–∞–≤–ª–æ–≤–∏—á –ß–µ—Ö–æ–≤", 
                "–≥–æ–≥–æ–ª—å": "–ù–∏–∫–æ–ª–∞–π –í–∞—Å–∏–ª—å–µ–≤–∏—á –ì–æ–≥–æ–ª—å"
            }
            
            welcome_messages = {
                "–ø—É—à–∫–∏–Ω": "–û, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é! –ì–æ—Ç–æ–≤ –∫ –ø–æ—ç—Ç–∏—á–µ—Å–∫–æ–π –±–µ—Å–µ–¥–µ –æ –ª—é–±–≤–∏, –¥—Ä—É–∂–±–µ –∏ —Å–≤–æ–±–æ–¥–µ. üñãÔ∏è",
                "–¥–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ... –ì–æ—Ç–æ–≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –≥–ª—É–±–∏–Ω—ã —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–π –¥—É—à–∏. üé≠",
                "—Ç–æ–ª—Å—Ç–æ–π": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –¥—Ä—É–≥ –º–æ–π. –ì–æ—Ç–æ–≤ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å –æ –≤–µ—á–Ω–æ–º –∏ –≤–∞–∂–Ω–æ–º. üìñ", 
                "—á–µ—Ö–æ–≤": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ. –ì–æ—Ç–æ–≤ –∫ —Ç–æ—á–Ω—ã–º –∏ –∏—Ä–æ–Ω–∏—á–Ω—ã–º –Ω–∞–±–ª—é–¥–µ–Ω–∏—è–º. ‚úíÔ∏è",
                "–≥–æ–≥–æ–ª—å": "–ê, –∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ì–æ—Ç–æ–≤ –∫ —Å–∞–º–æ–π –Ω–µ–æ–±—ã—á–Ω–æ–π –±–µ—Å–µ–¥–µ! üîÆ"
            }
            
            await message.answer(
                f"*{writer_names[writer]}*\n\n"
                f"{welcome_messages[writer]}\n\n"
                f"–ó–∞–¥–∞–≤–∞–π—Ç–µ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã - –æ—Ç –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã—Ö –¥–æ —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏—Ö!",
                parse_mode="Markdown",
                reply_markup=get_main_keyboard()
            )
            return
    
    # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ
    await message.answer(
        "–í—ã–±–µ—Ä–∏—Ç–µ –ø–∏—Å–∞—Ç–µ–ª—è –¥–ª—è –Ω–∞—á–∞–ª–∞ –±–µ—Å–µ–¥—ã! üìö\n\n"
        "–ù–∞–∂–º–∏—Ç–µ ¬´üìö –í—ã–±—Ä–∞—Ç—å –ø–∏—Å–∞—Ç–µ–ª—è¬ª –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –∏–º—è –∞–≤—Ç–æ—Ä–∞.",
        reply_markup=get_main_keyboard()
    )

async def main():
    print("üåü –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π –±–æ—Ç –∑–∞–ø—É—â–µ–Ω!")
    print("üìö –ì–æ—Ç–æ–≤ –∫ –≥–ª—É–±–æ–∫–∏–º –±–µ—Å–µ–¥–∞–º —Å –≤–µ–ª–∏–∫–∏–º–∏ –ø–∏—Å–∞—Ç–µ–ª—è–º–∏!")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
