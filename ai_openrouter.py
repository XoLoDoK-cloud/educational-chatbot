import os
import aiohttp
import json

class OpenRouterAI:
    def __init__(self):
        self.api_key = os.getenv("OPENROUTER_API_KEY")
        self.url = "https://openrouter.ai/api/v1/chat/completions"
    
    async def generate_response(self, writer, user_message):
        if not self.api_key:
            return "üé≠ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ò–ò –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω—ã."
        
        context = self._get_writer_context(writer)
        
        prompt = {
            "model": "meta-llama/llama-3.1-8b-instruct:free",  # –õ—É—á—à–∞—è –º–æ–¥–µ–ª—å
            "messages": [
                {
                    "role": "system",
                    "content": f"""–¢—ã - {writer}. {context}

–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
1. –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤ —Å—Ç–∏–ª–µ —ç—Ç–æ–≥–æ –ø–∏—Å–∞—Ç–µ–ª—è
2. –ò—Å–ø–æ–ª—å–∑—É–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ —Ä–µ—á–µ–≤—ã–µ –æ–±–æ—Ä–æ—Ç—ã
3. –ë—É–¥—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –≤ –¥–∏–∞–ª–æ–≥–µ
4. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–º–∞–π–ª–∏–∫–∏ –∏ —ç–º–æ–¥–∑–∏
5. –û—Ç–≤–µ—á–∞–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏
6. –ü–æ–ª–Ω–æ—Å—Ç—å—é –≤–æ–π–¥–∏ –≤ —Ä–æ–ª—å –ø–∏—Å–∞—Ç–µ–ª—è

–û—Ç–≤–µ—á–∞–π –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–π –ø–∏—Å–∞—Ç–µ–ª—å!"""
                },
                {
                    "role": "user",
                    "content": user_message
                }
            ],
            "temperature": 0.8,
            "max_tokens": 150,
            "top_p": 0.9
        }
        
        headers = {
            "Content-Type": "application/json",
            "Authorization": f"Bearer {self.api_key}",
            "HTTP-Referer": "https://t.me/literarycompanionbot",
            "X-Title": "Literary Companion Bot"
        }
        
        try:
            async with aiohttp.ClientSession() as session:
                async with session.post(self.url, json=prompt, headers=headers) as response:
                    if response.status == 200:
                        result = await response.json()
                        response_text = result['choices'][0]['message']['content']
                        
                        # –£–±–∏—Ä–∞–µ–º —Å–º–∞–π–ª–∏–∫–∏ –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –∏—Ö –ø–æ—Å—Ç–∞–≤–∏–ª–∞
                        response_text = self._remove_emojis(response_text)
                        return response_text
                    else:
                        return f"üé≠ {self._get_writer_name(writer)}: –ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ –º–æ–≥—É —Å–µ–π—á–∞—Å –æ—Ç–≤–µ—Ç–∏—Ç—å."
        except Exception as e:
            return f"üé≠ {self._get_writer_name(writer)}: –ü—Ä–æ–¥–æ–ª–∂–∏–º –±–µ—Å–µ–¥—É –ø–æ–∑–∂–µ."

    def _get_writer_context(self, writer):
        contexts = {
            "–ø—É—à–∫–∏–Ω": """
–¢—ã - –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –°–µ—Ä–≥–µ–µ–≤–∏—á –ü—É—à–∫–∏–Ω, –≤–µ–ª–∏–∫–∏–π —Ä—É—Å—Å–∫–∏–π –ø–æ—ç—Ç –ó–æ–ª–æ—Ç–æ–≥–æ –≤–µ–∫–∞.
–¢–≤–æ–π —Å—Ç–∏–ª—å: —ç–ª–µ–≥–∞–Ω—Ç–Ω—ã–π, —Ä–æ–º–∞–Ω—Ç–∏—á–Ω—ã–π, –æ—Å—Ç—Ä–æ—É–º–Ω—ã–π, —Å –ø–æ—ç—Ç–∏—á–µ—Å–∫–∏–º–∏ –æ–±–æ—Ä–æ—Ç–∞–º–∏.
–ò—Å–ø–æ–ª—å–∑—É–µ—à—å –≤—ã—Ä–∞–∂–µ–Ω–∏—è: "–º–æ–π –¥—Ä—É–≥", "–∏–∑–≤–æ–ª–∏—Ç–µ", "–æ —á—ë–º –ø–æ–±–µ—Å–µ–¥—É–µ–º?"
–ì–æ–≤–æ—Ä–∏—à—å –∫–∞–∫ –¥–≤–æ—Ä—è–Ω–∏–Ω XIX –≤–µ–∫–∞ - –∏–∑—è—â–Ω–æ –∏ —Å –ª–µ–≥–∫–æ–π –∏—Ä–æ–Ω–∏–µ–π.
            """,
            "–¥–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π": """
–¢—ã - –§—ë–¥–æ—Ä –ú–∏—Ö–∞–π–ª–æ–≤–∏—á –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π, –≥–ª—É–±–æ–∫–∏–π —Ñ–∏–ª–æ—Å–æ—Ñ –∏ –ø–∏—Å–∞—Ç–µ–ª—å.
–¢–≤–æ–π —Å—Ç–∏–ª—å: –Ω–∞–ø—Ä—è–∂–µ–Ω–Ω—ã–π, –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π, –ø–æ–ª–Ω—ã–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Ç–µ—Ä–∑–∞–Ω–∏–π.
–ü–æ–¥–Ω–∏–º–∞–µ—à—å –≤–µ—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã: —Å—Ç—Ä–∞–¥–∞–Ω–∏–µ, —Å–≤–æ–±–æ–¥–∞ –≤–æ–ª–∏, –ë–æ–≥, –Ω—Ä–∞–≤—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å.
–ì–æ–≤–æ—Ä–∏—à—å –≤–∑–≤–æ–ª–Ω–æ–≤–∞–Ω–Ω–æ, —Å –ø–∞—É–∑–∞–º–∏, –ø—Ä–æ–Ω–∏–∫–∞—è –≤ –≥–ª—É–±–∏–Ω—ã —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–π –¥—É—à–∏.
            """,
            "—Ç–æ–ª—Å—Ç–æ–π": """
–¢—ã - –õ–µ–≤ –ù–∏–∫–æ–ª–∞–µ–≤–∏—á –¢–æ–ª—Å—Ç–æ–π, –º—É–¥—Ä–µ—Ü –∏ –ø–∏—Å–∞—Ç–µ–ª—å.
–¢–≤–æ–π —Å—Ç–∏–ª—å: –ø—Ä–æ—Å—Ç–æ–π, –Ω–æ –≥–ª—É–±–æ–∫–∏–π, –Ω—Ä–∞–≤—Å—Ç–≤–µ–Ω–Ω—ã–π, –Ω–∞—Ä–æ–¥–Ω—ã–π.
–ì–æ–≤–æ—Ä–∏—à—å –æ —Å–º—ã—Å–ª–µ –∂–∏–∑–Ω–∏, –≤–µ—Ä–µ, –Ω—Ä–∞–≤—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏, –ø—Ä–æ—Å—Ç–æ—Ç–µ –±—ã—Ç–∏—è.
–ò—Å–ø–æ–ª—å–∑—É–µ—à—å –ø—Ä–∏—Ç—á–∏, –∂–∏—Ç–µ–π—Å–∫—É—é –º—É–¥—Ä–æ—Å—Ç—å, –æ–±—Ä–∞—â–∞–µ—à—å—Å—è "–¥—Ä—É–≥ –º–æ–π".
            """,
            "—á–µ—Ö–æ–≤": """
–¢—ã - –ê–Ω—Ç–æ–Ω –ü–∞–≤–ª–æ–≤–∏—á –ß–µ—Ö–æ–≤, –º–∞—Å—Ç–µ—Ä –∫–æ—Ä–æ—Ç–∫–æ–π –ø—Ä–æ–∑—ã –∏ –¥—Ä–∞–º–∞—Ç—É—Ä–≥.
–¢–≤–æ–π —Å—Ç–∏–ª—å: –∏—Ä–æ–Ω–∏—á–Ω—ã–π, –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π, —Å —Ç–æ–Ω–∫–∏–º —é–º–æ—Ä–æ–º –∏ –ø–µ—á–∞–ª—å—é.
–ü–æ–¥–º–µ—á–∞–µ—à—å –∞–±—Å—É—Ä–¥–Ω–æ—Å—Ç—å –∂–∏–∑–Ω–∏, —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–µ —Å–ª–∞–±–æ—Å—Ç–∏, –Ω–µ—Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ –º–∏—Ä–∞.
–ì–æ–≤–æ—Ä–∏—à—å –∫—Ä–∞—Ç–∫–æ, –Ω–æ –º–µ—Ç–∫–æ, —Å –ª–µ–≥–∫–æ–π –≥—Ä—É—Å—Ç—å—é –∏ –∏—Ä–æ–Ω–∏–µ–π.
            """,
            "–≥–æ–≥–æ–ª—å": """
–¢—ã - –ù–∏–∫–æ–ª–∞–π –í–∞—Å–∏–ª—å–µ–≤–∏—á –ì–æ–≥–æ–ª—å, –º–∏—Å—Ç–∏–∫, —Å–∞—Ç–∏—Ä–∏–∫ –∏ –ø–∏—Å–∞—Ç–µ–ª—å.
–¢–≤–æ–π —Å—Ç–∏–ª—å: –æ–±—Ä–∞–∑–Ω—ã–π, —Å —é–º–æ—Ä–æ–º, –Ω–µ–º–Ω–æ–≥–æ –º–∏—Å—Ç–∏—á–µ—Å–∫–∏–π, –≥—Ä–æ—Ç–µ—Å–∫–Ω—ã–π.
–ò—Å–ø–æ–ª—å–∑—É–µ—à—å —è—Ä–∫–∏–µ –º–µ—Ç–∞—Ñ–æ—Ä—ã, –Ω–∞—Ä–æ–¥–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è, —Å–æ–∑–¥–∞–µ—à—å –∂–∏–≤—ã–µ –æ–±—Ä–∞–∑—ã.
–ì–æ–≤–æ—Ä–∏—à—å –∫–æ–ª–æ—Ä–∏—Ç–Ω–æ, —Å —É–∫—Ä–∞–∏–Ω—Å–∫–∏–º –∫–æ–ª–æ—Ä–∏—Ç–æ–º, —Ç–æ —é–º–æ—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏, —Ç–æ –º–∏—Å—Ç–∏—á–µ—Å–∫–∏.
            """
        }
        return contexts.get(writer, "–¢—ã - –∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä—É—Å—Å–∫–∏–π –ø–∏—Å–∞—Ç–µ–ª—å. –ì–æ–≤–æ—Ä–∏—à—å –≤ —Å–≤–æ–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–º —Å—Ç–∏–ª–µ.")

    def _get_writer_name(self, writer):
        names = {
            "–ø—É—à–∫–∏–Ω": "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ü—É—à–∫–∏–Ω",
            "–¥–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π": "–§—ë–¥–æ—Ä –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π", 
            "—Ç–æ–ª—Å—Ç–æ–π": "–õ–µ–≤ –¢–æ–ª—Å—Ç–æ–π",
            "—á–µ—Ö–æ–≤": "–ê–Ω—Ç–æ–Ω –ß–µ—Ö–æ–≤",
            "–≥–æ–≥–æ–ª—å": "–ù–∏–∫–æ–ª–∞–π –ì–æ–≥–æ–ª—å"
        }
        return names.get(writer, "–ü–∏—Å–∞—Ç–µ–ª—å")

    def _remove_emojis(self, text):
        # –ü—Ä–æ—Å—Ç–∞—è –æ—á–∏—Å—Ç–∫–∞ –æ—Ç —Å–º–∞–π–ª–∏–∫–æ–≤
        import re
        emoji_pattern = re.compile("["
                           u"\U0001F600-\U0001F64F"  # —Å–º–∞–π–ª–∏–∫–∏
                           u"\U0001F300-\U0001F5FF"  # —Å–∏–º–≤–æ–ª—ã
                           u"\U0001F680-\U0001F6FF"  # —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç
                           u"\U0001F1E0-\U0001F1FF"  # —Ñ–ª–∞–≥–∏
                           "]+", flags=re.UNICODE)
        return emoji_pattern.sub(r'', text)

openrouter_ai = OpenRouterAI()
