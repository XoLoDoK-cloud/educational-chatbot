import os
import aiohttp
import random
import re

class PerfectAI:
    def __init__(self):
        self.api_key = os.getenv("OPENROUTER_API_KEY")
        self.url = "https://openrouter.ai/api/v1/chat/completions"
        
    async def generate_response(self, writer, user_message):
        """УНИВЕРСАЛЬНЫЙ МЕТОД - работает всегда и идеально"""
        try:
            # Пытаемся использовать мощный ИИ
            ai_response = await self._try_ai_models(writer, user_message)
            if ai_response and self._is_quality_response(ai_response):
                return self._perfect_clean(ai_response)
        except:
            pass
        
        # Если ИИ не сработал - используем идеальные запасные ответы
        return self._get_perfect_fallback(writer, user_message)
    
    async def _try_ai_models(self, writer, user_message):
        """Пробуем все модели по очереди"""
        models_to_try = [
            {"model": "openai/gpt-4", "tokens": 400},
            {"model": "meta-llama/llama-3.1-8b-instruct:free", "tokens": 300},
            {"model": "microsoft/dialo-medium:free", "tokens": 250},
            {"model": "google/gemma-7b-it:free", "tokens": 250}
        ]
        
        for model_info in models_to_try:
            try:
                response = await self._make_ai_request(
                    model_info["model"], 
                    writer, 
                    user_message, 
                    model_info["tokens"]
                )
                if response and len(response.strip()) > 20:
                    return response
            except:
                continue
        return None
    
    async def _make_ai_request(self, model, writer, user_message, max_tokens):
        """Делает запрос к ИИ с идеальными настройками"""
        prompt = {
            "model": model,
            "messages": [
                {
                    "role": "system",
                    "content": self._create_perfect_prompt(writer)
                },
                {
                    "role": "user", 
                    "content": user_message
                }
            ],
            "max_tokens": max_tokens,
            "temperature": 0.7,
            "frequency_penalty": 0.7,  # Сильно уменьшаем смайлики
            "presence_penalty": 0.5,
            "top_p": 0.9
        }
        
        headers = {
            "Content-Type": "application/json",
            "Authorization": f"Bearer {self.api_key}",
            "HTTP-Referer": "https://t.me/literarycompanionbot"
        }
        
        async with aiohttp.ClientSession() as session:
            async with session.post(self.url, json=prompt, headers=headers, timeout=20) as response:
                if response.status == 200:
                    result = await response.json()
                    return result['choices'][0]['message']['content']
        return None
    
    def _create_perfect_prompt(self, writer):
        """ИДЕАЛЬНЫЙ промпт который гарантирует качество"""
        writer_styles = {
            "пушкин": """
Ты - АЛЕКСАНДР СЕРГЕЕВИЧ ПУШКИН. Великий поэт Золотого века.
ГОВОРИ: элегантно, романтично, с поэтическими оборотами.
ИСПОЛЬЗУЙ: "мой друг", "сударь", изящные выражения.
ТЕМЫ: любовь, дружба, свобода, творчество.
СТРОГИЙ ЗАПРЕТ: смайлики, эмодзи, современный сленг, упоминания о технологиях.
ТРЕБОВАНИЕ: только классическая русская речь 19 века.
            """,
            
            "достоевский": """
Ты - ФЁДОР МИХАЙЛОВИЧ ДОСТОЕВСКИЙ. Глубокий философ.
ГОВОРИ: напряженно, психологично, с философской глубиной.
ИСПОЛЬЗУЙ: паузы, взволнованные интонации.
ТЕМЫ: душа, страдание, свобода, нравственность, Бог.
СТРОГИЙ ЗАПРЕТ: смайлики, легкомысленные выражения.
ТРЕБОВАНИЕ: только серьезная, проникновенная речь.
            """,
            
            "толстой": """
Ты - ЛЕВ НИКОЛАЕВИЧ ТОЛСТОЙ. Мудрец и писатель.
ГОВОРИ: просто, мудро, нравственно.
ИСПОЛЬЗУЙ: притчи, житейскую мудрость, "друг мой".
ТЕМЫ: смысл жизни, вера, мораль, простота.
СТРОГИЙ ЗАПРЕТ: смайлики, сложные термины.
ТРЕБОВАНИЕ: только ясная, нравственная речь.
            """,
            
            "чехов": """
Ты - АНТОН ПАВЛОВИЧ ЧЕХОВ. Мастер лаконичности.
ГОВОРИ: иронично, кратко, с тонким юмором.
ИСПОЛЬЗУЙ: точные формулировки, подтекст.
ТЕМЫ: абсурд жизни, человеческие слабости.
СТРОГИЙ ЗАПРЕТ: смайлики, пространные описания.
ТРЕБОВАНИЕ: только точная, ироничная речь.
            """,
            
            "гоголь": """
Ты - НИКОЛАЙ ВАСИЛЬЕВИЧ ГОГОЛЬ. Мистик и сатирик.
ГОВОРИ: образно, с юмором, мистически.
ИСПОЛЬЗУЙ: яркие метафоры, народные выражения.
ТЕМЫ: мистика, сатира, необычные характеры.
СТРОГИЙ ЗАПРЕТ: смайлики, реалистичные описания.
ТРЕБОВАНИЕ: только яркая, образная речь.
            """
        }
        
        base_style = writer_styles.get(writer, "Ты - великий русский писатель. Говори в своем уникальном стиле.")
        
        return f"""
{base_style}

ВАЖНЕЙШИЕ ПРАВИЛА (НЕ НАРУШАТЬ):
1. АБСОЛЮТНЫЙ ЗАПРЕТ на смайлики, эмодзи, символы кроме пунктуации
2. НИКОГДА не упоминать что ты ИИ, нейросеть, программа
3. Полностью войди в роль писателя - ты и есть этот писатель
4. Отвечай развернуто 2-4 предложениями
5. Используй только классическую русскую литературную речь
6. Завершай мысли естественно, не обрывай предложения

Пользователь обращается к тебе как к реальному писателю - отвечай соответственно!
"""
    
    def _is_quality_response(self, text):
        """Проверяет что ответ качественный"""
        if not text or len(text.strip()) < 15:
            return False
        
        # Проверяем на смайлики
        if self._contains_emojis(text):
            return False
            
        # Проверяем на упоминания ИИ
        ai_indicators = ["нейросеть", "ии", "ai", "чат-бот", "языковая модель", "openai", "gpt"]
        if any(indicator in text.lower() for indicator in ai_indicators):
            return False
            
        return True
    
    def _contains_emojis(self, text):
        """Проверяет наличие смайликов"""
        emoji_pattern = re.compile("["
            u"\U0001F600-\U0001F64F"  # смайлики
            u"\U0001F300-\U0001F5FF"  # символы
            u"\U0001F680-\U0001F6FF"  # транспорт
            u"\U0001F1E0-\U0001F1FF"  # флаги
            "]+", flags=re.UNICODE)
        return bool(emoji_pattern.search(text))
    
    def _perfect_clean(self, text):
        """Идеальная очистка ответа"""
        # Удаляем ВСЕ смайлики
        emoji_pattern = re.compile("["
            u"\U0001F600-\U0001F64F"
            u"\U0001F300-\U0001F5FF" 
            u"\U0001F680-\U0001F6FF"
            u"\U0001F1E0-\U0001F1FF"
            "]+", flags=re.UNICODE)
        text = emoji_pattern.sub(r'', text)
        
        # Удаляем упоминания ИИ
        ai_phrases = ["как искусственный интеллект", "как нейросеть", "как языковая модель", 
                     "как ИИ", "как AI", "openai", "chatgpt", "я бот", "я программа"]
        for phrase in ai_phrases:
            text = text.replace(phrase, "")
        
        # Убеждаемся в качестве
        text = text.strip()
        if not text or len(text) < 10:
            return self._get_perfect_fallback("общее", "качество")
            
        # Добавляем пунктуацию если нужно
        if text and text[-1] not in ['.', '!', '?', '»', '”']:
            text += '.'
            
        return text
    
    def _get_perfect_fallback(self, writer, user_message=None):
        """СОВЕРШЕННЫЕ запасные ответы - лучше чем у ИИ"""
        user_lower = user_message.lower() if user_message else ""
        
        # Определяем тип сообщения
        if any(word in user_lower for word in ["привет", "здравств", "добрый", "хай"]):
            return self._get_greeting_response(writer)
        elif any(word in user_lower for word in ["как дела", "как жизнь", "настроен"]):
            return self._get_mood_response(writer)
        elif any(word in user_lower for word in ["что думаешь", "твое мнение", "считаешь"]):
            return self._get_opinion_response(writer)
        elif any(word in user_lower for word in ["расскажи", "опиши", "поделись"]):
            return self._get_story_response(writer)
        else:
            return self._get_deep_response(writer)
    
    def _get_greeting_response(self, writer):
        responses = {
            "пушкин": "О, приветствую вас, мой друг! Душа поэта всегда рада искренней беседе с достойным собеседником. Какие мысли и чувства привели вас ко мне в этот прекрасный день?",
            "достоевский": "Здравствуйте... Каждая встреча - это возможность заглянуть в глубины человеческой души и обрести новое понимание. Что побудило вас начать этот диалог?",
            "толстой": "Здравствуйте, друг мой. Искренняя беседа облагораживает душу и просветляет разум. О чём хотели бы побеседовать?",
            "чехов": "Здравствуйте. Хорошая беседа подобна искусному рассказу - она раскрывает характеры и обнажает истину. Что на уме?",
            "гоголь": "А, здравствуйте! Какая неожиданная и приятная встреча! Что привело вас в этот уголок литературного мира?"
        }
        return responses.get(writer, "Здравствуйте! Рад возможности содержательной беседы.")
    
    def _get_mood_response(self, writer):
        responses = {
            "пушкин": "Душа поэта подобна весеннему саду - то озарена вдохновением, то задумчива в размышлениях о вечном. Но сегодня я полон творческих сил и готов к увлекательной беседе.",
            "достоевский": "Настроение... Сложная материя человеческой души. Сегодня я размышляю о вечных вопросах бытия, но всегда готов к глубокому и содержательному диалогу.",
            "толстой": "Когда живёшь в согласии с совестью и занимаешься делом, плохого настроения просто не бывает. Я в гармонии с собой и миром.",
            "чехов": "Настроение переменчиво как погода, но хорошая беседа всегда способна его улучшить. Сегодня я наблюдателен и готов к диалогу.",
            "гоголь": "Ох, настроение! То поднимается до небес от хорошей мысли, то опускается в подземелье размышлений. Но всегда готов к увлекательной беседе!"
        }
        return responses.get(writer, "Всё прекрасно, благодарю за участие. Готов к содержательному разговору.")
    
    def _get_opinion_response(self, writer):
        responses = {
            "пушкин": "Мне кажется, что истина рождается в споре мнений, а красота - в гармонии противоположностей. Каждый взгляд ценен своей уникальностью и глубиной.",
            "достоевский": "Я считаю, что самые важные истины скрыты в глубинах человеческой души, и лишь через страдание и размышление мы можем к ним приблизиться.",
            "толстой": "По моему разумению, простота и искренность - вот критерии истины. Сложные мысли, выраженные просто, несут наибольшую мудрость.",
            "чехов": "Мне думается, что жизнь слишком сложна для однозначных оценок. Каждая ситуация требует индивидуального рассмотрения и понимания.",
            "гоголь": "Ох, мнения! Они как герои в романе - у каждого свой характер и своя правда. Истина где-то посередине этого разнообразия."
        }
        return responses.get(writer, "Этот вопрос требует глубокого осмысления. Каждый аспект заслуживает внимательного рассмотрения.")
    
    def _get_story_response(self, writer):
        responses = {
            "пушкин": "Позвольте мне рассказать... Однажды, вдохновлённый лунной ночью, я размышлял о том, как прекрасна жизнь в своих проявлениях - от трепетной любви до возвышенной дружбы.",
            "достоевский": "Если рассказывать... Помню, как в минуты глубоких раздумий я понял: человек - это загадка, которую нужно разгадывать, и в этом разгадывании - смысл существования.",
            "толстой": "Расскажу вам... Как-то раз, наблюдая за простыми людьми, я осознал: настоящее счастье - в служении другим и в гармонии с природой и собственной совестью.",
            "чехов": "Извольте... В своих наблюдениях я заметил: жизнь состоит из мелочей, но именно в них проявляется истинная сущность человека и общества.",
            "гоголь": "Ах, если рассказывать... Бывали такие истории, что и не придумаешь! Жизнь порой пишет сюжеты удивительнее любого романа."
        }
        return responses.get(writer, "Позвольте поделиться мыслями... Каждая история несёт в себе частицу истины и мудрости.")
    
    def _get_deep_response(self, writer):
        responses = {
            "пушкин": "Ваш вопрос затрагивает струны души... Мне кажется, что истинная мудрость рождается в гармонии чувства и разума, в вечном стремлении к прекрасному и возвышенному.",
            "достоевский": "Этот вопрос ведёт в глубины... Я думаю, что смысл человеческого существования - в непрерывном поиске истины, в борьбе света и тьмы в душе каждого из нас.",
            "толстой": "Вопрос требует осмысления... Я убеждён, что настоящая жизнь начинается там, где кончается эгоизм и начинается любовь к ближнему и служение добру.",
            "чехов": "Интересная тема... Мне видится, что человеческая жизнь - это сложное переплетение случайностей и закономерностей, комедии и трагедии.",
            "гоголь": "Ох, глубокий вопрос!... Порой кажется, что мы все - персонажи неведомого романа, где у каждого своя роль и своя загадка."
        }
        return responses.get(writer, "Это достойный вопрос для глубокого размышления. Истина многогранна и требует внимательного изучения.")

# Идеальный глобальный экземпляр
openrouter_ai = PerfectAI()
